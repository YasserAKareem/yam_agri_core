<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <style>
    body { font-family: Arial, sans-serif; font-size: 11px; color: #1f2937; }
    .header { border-bottom: 2px solid #111827; padding-bottom: 6px; margin-bottom: 10px; }
    h1 { font-size: 16px; margin: 0; }
    .meta { margin-top: 4px; color: #374151; }
    .section { margin-top: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #d1d5db; padding: 4px; vertical-align: top; }
    th { background: #f3f4f6; text-align: left; }
    .muted { color: #6b7280; font-size: 10px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>EvidencePack {{ doc.name }}</h1>
    <div class="meta">
      <strong>Title:</strong> {{ doc.title or "N/A" }} |
      <strong>Site:</strong> {{ doc.site or "N/A" }} |
      <strong>Lot:</strong> {{ doc.lot or "All" }}
    </div>
    <div class="meta">
      <strong>Date Range:</strong> {{ doc.from_date or "N/A" }} to {{ doc.to_date or "N/A" }} |
      <strong>Status:</strong> {{ doc.status or "Draft" }} |
      <strong>Generated:</strong> {{ generated_on }}
    </div>
  </div>

  <div class="section">
    <strong>Scope Counts</strong>
    <table>
      <thead>
        <tr>
          <th>Source</th>
          <th>Count</th>
        </tr>
      </thead>
      <tbody>
        {% for source, count in counts.items() %}
        <tr>
          <td>{{ source }}</td>
          <td>{{ count }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if narrative %}
  <div class="section">
    <strong>Approved AI Narrative</strong>
    <div style="margin-top: 6px; white-space: pre-wrap; border: 1px solid #d1d5db; padding: 8px;">{{ narrative }}</div>
    <div class="muted" style="margin-top: 4px;">Narrative is included only when AI suggestion was explicitly accepted.</div>
  </div>
  {% endif %}

  <div class="section">
    <strong>Linked Evidence Records</strong>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Source</th>
          <th>Record</th>
          <th>Date</th>
          <th>Status</th>
          <th>Files</th>
          <th>Summary</th>
        </tr>
      </thead>
      <tbody>
        {% for row in linked_documents %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ row.source_doctype }}</td>
          <td>{{ row.source_name }}</td>
          <td>{{ row.document_date or "" }}</td>
          <td>{{ row.status or "" }}</td>
          <td>{{ row.attachment_count or 0 }}</td>
          <td>{{ row.summary or "" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</body>
</html>
